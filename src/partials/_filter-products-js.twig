<script type="text/javascript">
    $(function (){
    // Filters and orders
    var HOST = window.location.host;
    var PROTOCOL = window.location.protocol;
    var PATHNAME = window.location.pathname;
    var BASEURL = PROTOCOL + '//' + HOST + PATHNAME;

    var FilterState = {
        color: [],
        talla: [],
        tags: [],
        minprice: null,
        maxprice: null,
        pricerange: null,
        orderBy: null
    }

    var $selector = $('.filtersbar .selector');
    var enableOrderBy = function() {
      $('.filtersbar .selector .selector__title').on('click', function(){
        $(this).parent('.selector').toggleClass('active');
      });
      $('.filtersbar .selector .selector__item').on('click', function(){
        var option = $(this);
        option.siblings().removeClass('selection');
        option.toggleClass('selection');
        $selector.removeClass('active');
        if(option.hasClass('selection') && FilterState.orderBy != option.data('value')) {
          var $label = $('.filtersbar .selector .selector__title span');
          FilterState.orderBy = option.data('value');
          switch(FilterState.orderBy) {
            case 'created-descending':
              $label.text('Más viejo');
              break;
            case 'created-ascending':
              $label.text('Más nuevo');
              break;
            case 'price-ascending':
              $label.text('Precio ascendente');
              break;
            case 'price-descending':
              $label.text('Precio descendente');
              break;
            case 'name-ascending':
              $label.text('A-Z');
              break;
            case 'name-descending':
              $label.text('Z-A');
              break;
            default:
              $label.text('');
          }
        }
        var _url = '?';
        var fireEvent = $('.filtersbar').hasClass('active');
        $(this).parent('.selector').toggleClass('active');
        if(!fireEvent){
         _url += FilterState.orderBy != null ? '&sort_by='+FilterState.orderBy : '';
          _url = buildUrl(_url);
        redirectToUrl(_url);
        }
      });
      $('.selector__list').mouseleave(function(){
        $selector.removeClass('active');
      });
    }
    enableOrderBy();
    var enableFilterBy = function(){
      $('.filtersbar .filter .filter__title').on('click', function(){
        $(this).parent().toggleClass('active');
        $('.filtersbar').toggleClass('active');
      });
    }
    enableFilterBy();
    var filterOptionSelector = function(){
      $('.filter__options .filter__option').on('click', function(){
        var _this = $(this);
        var _type = _this.data('type');
        var _value = _this.data('filter');
        _this.toggleClass('active');
        if ($(this).hasClass('active')) {
          FilterState[_type].push(_value.toString());
        } else {
          FilterState[_type] = FilterState[_type].filter(function(value){
            return _value != value;
          });
        }
        $('.filters-apply button.btn').removeClass('btn-disabled');
        console.log(FilterState);
      });
      $('.filters-apply .text-link').on('click', function(){
        $('.filters-apply button.btn').addClass('btn-disabled');
        $('.filtersbar, .filtersbar .filter, .filter-frame.filter .filter__options .filter__option').removeClass('active');
      });
      $('.filter__options.type-price-range .filter__option').on('click', function(){
        $(this).addClass('active');
        $(this).siblings().removeClass('active');
      });
      $('.filters-apply button.btn').on('click', function(){
       fireFilterQuery();
      });
      return true;
    }
    filterOptionSelector();

    var setInitialFiltersFromUrl = function() {
      var _url = decodeURIComponent(window.location.search.substring(1));
      var _urlVars = _url.split('&');
      var _parameterName;
      var i;
      if (_url.length != 0) {
        $('.filters-apply button').removeClass('btn-disabled');
        for (i = 0; i < _urlVars.length; i++) {
          _parameterName = _urlVars[i].split('=');
          if (_parameterName[0] === 'options[color]') {
            _paramColor = _parameterName[1].split(',');
            _paramColor.forEach(function(value, key) {
              if (!FilterState['color'].includes(value)) {
                FilterState['color'].push(value);
              }
            });
          }

          if (_parameterName[0] === 'options[talla]') {
            _paramSize = _parameterName[1].split(',');
            _paramSize.forEach(function(value, key) {
              if (!FilterState['talla'].includes(value)) {
                FilterState['talla'].push(value);
              }
            });
          }

          if (_parameterName[0] === 'q') {
            _paramTag = _parameterName[1].split(',');
            _paramTag.forEach(function(value, key) {
              if (!FilterState['tags'].includes(value)) {
                FilterState['tags'].push(value);
              }
            });
          }

          if (_parameterName[0] === 'price[min]') {
            _paramTag = _parameterName[1].split(',');
            _paramTag.forEach(function(value, key) {
              FilterState['minprice'] = value;
            });
          }

          if (_parameterName[0] === 'price[max]') {
            _paramTag = _parameterName[1].split(',');
            _paramTag.forEach(function(value, key) {
              FilterState['maxprice'] = value;
            });
          }

          if (_parameterName[0] === 'sort_by') {
            _paramTag = _parameterName[1].split(',');
            _paramTag.forEach(function(value, key) {
              FilterState['orderBy'] = value;
            });
          }
        }
        console.log(FilterState);
      }
      FilterState['pricerange'] = (FilterState['minprice'] != null ? FilterState['minprice'] : 0) + '-' + (FilterState['maxprice'] != null ? FilterState['maxprice'] : 20000);
      return true;
    };
    setInitialFiltersFromUrl();

    var checkAlreadySelectedOptions = function(){
      if(FilterState.color.length > 0 ) {
        FilterState['color'].forEach(function(value, index){
          $('.filter__options.type-color .filter__option[data-filter="'+value+'"]').addClass('active');
        });
      }

      if(FilterState.talla.length > 0 ) {
        FilterState['talla'].forEach(function(value, index){
          $('.filter__options.type-size .filter__option[data-filter="'+value+'"]').addClass('active');
        });
      }

      if(FilterState.tags.length > 0 ) {
        FilterState['tags'].forEach(function(value, index){
          $('.filter__option[data-filter="'+value+'"]').addClass('active');
        });
      }
    }
    checkAlreadySelectedOptions();

    var updateFilterStateBeforeRequest = function(){
      $('.filter-frame.filter .filter__options .filter__option').each(function(){
          var $this = $(this);
          if($this.hasClass('active') && $this.data('type') != 'pricerange'){
            if (FilterState[$this.data('type')][$this.data('filter')]  == -1) {
              FilterState[$this.data('type')].push($this.data('filter'));
            }
          }
      });
      var $pricerange = $('.filter-frame.filter .filter__options.type-price-range .filter__option.active').data('filter');
      if($pricerange != undefined && $pricerange != null) {
        FilterState['pricerange'] = $pricerange;
        FilterState['minprice'] = $pricerange.split('-')[0];
        FilterState['maxprice'] = $pricerange.split('-')[1];
      }
      return true
    }
    var getBaseUrl = function() {
      return PROTOCOL + '//' + ROOT + '/' + type;
    }
    var buildUrl = function(url) {
      var _url = url;
      _url = _url.replace("?&", "?");
      if (_url === "?") {
        return '';
      }
      return _url;
    };
    var redirectToUrl = function(url) {
      if(url === '') {
        window.location.href = BASEURL;
        return false;
      }
      window.location.href = url
    }
    var fireFilterQuery = function() {
      updateFilterStateBeforeRequest();
      var _url = "?";
         _url += FilterState.color.length >= 1 ? '&options[color]='+FilterState.color.join(',') : '';
         _url += FilterState.talla.length >= 1 ? '&options[talla]='+FilterState.talla.join(',') : '';
         _url += FilterState.tags.length >= 1 ? '&q='+FilterState.tags.join(',') : '';
         if(FilterState.minprice != null) {
         _url += (FilterState.minprice != null) ? '&price[min]='+FilterState.minprice : '';
         }
         if(!isNaN(Number(FilterState.maxprice))) {
         _url += (FilterState.maxprice != null) ? '&price[max]='+FilterState.maxprice : '';
         }
         _url += FilterState.orderBy != null ? '&sort_by='+FilterState.orderBy : '';
         _url = buildUrl(_url);
      redirectToUrl(_url);
      return true;
    }
    console.log(FilterState);
  });
</script>
